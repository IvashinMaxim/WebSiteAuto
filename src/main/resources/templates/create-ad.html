<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .form-section {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .section-title {
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: #0d6efd;
        }

        .image-upload {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #0d6efd;
            background-color: #f0f8ff;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header.html :: header}"></div>

<div class="container my-5">
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h1>

            <form th:action="@{/ads/create}" th:object="${ad}" method="post" enctype="multipart/form-data"
                  class="needs-validation" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-section">
                    <h3 class="section-title"><i class="bi bi-card-heading"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</label>
                            <input type="text" class="form-control" id="title" th:field="*{title}"
                                   th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'"
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥–∞–º Ford Focus 2018 –≥–æ–¥–∞" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}"
                                 th:errors="*{title}"></div>
                            <div class="form-text">–ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ–¥–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                        </div>
                        <div class="col-md-12">
                            <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="description" th:field="*{description}"
                                      th:classappend="${#fields.hasErrors('description')} ? 'is-invalid'"
                                      rows="2" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è..."
                                      required></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}"
                                 th:errors="*{description}"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="bi bi-car-front"></i> –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h3>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">–ú–∞—Ä–∫–∞</label>
                            <select id="brand"
                                    class="form-select"
                                    th:field="*{car.brand}"
                                    onchange="loadModels()">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ú–æ–¥–µ–ª—å</label>
                            <select id="model"
                                    class="form-select"
                                    th:field="*{car.model}"
                                    onchange="loadYears()"
                                    disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                            <select id="year"
                                    class="form-select"
                                    th:field="*{car.yearLow}"
                                    onchange="loadGenerationAndBodyTypes()" disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–ü–æ–∫–æ–ª–µ–Ω–∏–µ</label>
                            <select id="generation"
                                    class="form-select"
                                    th:field="*{car.generation}"
                                    onchange="loadBodyTypes()" disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–¶–≤–µ—Ç</label>
                            <select id="color"
                                    class="form-select"
                                    th:field="*{color}"
                                    disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–ö—É–∑–æ–≤</label>
                            <select id="bodyType"
                                    class="form-select"
                                    th:field="*{car.bodyType}"
                                    onchange="loadEngineTypes()"
                                    disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–¢–∏–ø –¥–≤–∏–≥–∞—Ç–µ–ª—è</label>
                            <select id="engineType"
                                    class="form-select"
                                    th:field="*{car.engineType}"
                                    onchange="loadEnginePowers()"
                                    disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">–ú–æ—â–Ω–æ—Å—Ç—å (–ª.—Å.) *</label>

                            <select id="enginePowerSelect"
                                    class="form-select"
                                    onchange="toggleEnginePowerInput(this.value)">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å</option>
                            </select>

                            <input type="number"
                                   id="enginePowerInput"
                                   th:field="*{car.enginePower}"
                                   class="form-control mt-2"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å –≤ –ª.—Å."
                                   style="display:none;"
                                   required
                                   onchange="loadTransmissions()">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">–ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á</label>
                            <select id="transmissionType"
                                    class="form-select"
                                    th:field="*{car.transmission}"
                                    onchange="loadDriveTypes()"
                                    disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">–ü—Ä–∏–≤–æ–¥</label>
                            <select id="driveType"
                                    class="form-select"
                                    th:field="*{car.driveType}"
                                    disabled>
                                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="mileage" class="form-label">–ü—Ä–æ–±–µ–≥ (–∫–º) *</label>
                            <input type="number" class="form-control" id="mileage" th:field="*{mileage}"
                                   th:classappend="${#fields.hasErrors('mileage')} ? 'is-invalid'"
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 75000" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('mileage')}"
                                 th:errors="*{mileage}"></div>
                        </div>

                        <div class="col-md-6">
                        </div>

                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><i class="bi bi-currency-exchange"></i> –¶–µ–Ω–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="price" class="form-label">–¶–µ–Ω–∞ ($) *</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="price" th:field="*{price}"
                                       th:classappend="${#fields.hasErrors('price')} ? 'is-invalid'"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000" required>
                                <span class="input-group-text">$</span></div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}"
                                 th:errors="*{price}"></div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</label>
                            <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                                <i class="bi bi-cloud-arrow-up" style="font-size: 2rem;"></i>
                                <p class="mt-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Ñ–∞–π–ª—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                                <p class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: –¥–æ 5 –ú–ë (JPG, PNG)</p>
                                <img id="imagePreview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                            </div>
                            <input type="file" id="imageInput" name="images" multiple accept="image/*"
                                   style="display: none;" onchange="previewImage(event)">
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a th:href="@{/ads}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const API = "/api/v1/ads/dictionary";

    function fetchDict(target, params = {}) {
        const url = new URL(API, window.location.origin);
        url.searchParams.set("target", target);

        Object.entries(params).forEach(([k, v]) => {
            if (v) url.searchParams.set(k, v);
        });

        return fetch(url)
            .then(r => r.json())
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
                return [];
            });
    }

    function fillSelect(id, list, placeholder) {
        const select = document.getElementById(id);
        select.innerHTML = "";

        const base = document.createElement("option");
        base.value = "";
        base.textContent = placeholder;
        select.appendChild(base);

        list.forEach(item => {
            const o = document.createElement("option");
            o.value = item;
            o.textContent = item;
            select.appendChild(o);
        });

        select.disabled = list.length === 0;
    }

    async function loadBrands() {
        const brands = await fetchDict("brand");
        fillSelect("brand", brands, "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä–∫—É");
    }

    async function loadModels() {
        const brand = document.getElementById("brand").value;

        fillSelect("model", [], "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å");
        fillSelect("year", [], "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥");
        fillSelect("bodyType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤");
        fillSelect("engineType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand) return;

        const models = await fetchDict("model", {brand});
        fillSelect("model", models, "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å");
    }

    async function loadYears() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;

        fillSelect("year", [], "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥");
        fillSelect("bodyType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤");
        fillSelect("engineType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand || !model) return;

        const years = await fetchDict("yearLow", {brand, model});
        fillSelect("year", years, "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥");
    }

    async function loadGenerationAndBodyTypes() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;

        // –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–ª–µ–π
        fillSelect("generation", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ");
        fillSelect("color", [], "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç");
        fillSelect("bodyType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤");
        fillSelect("engineType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand || !model || !yearLow) return;

        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–æ–∫–æ–ª–µ–Ω–∏–µ (generation)
        await loadGeneration(brand, model, yearLow);

        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¶–≤–µ—Ç (color) - –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Generation, —Ç–æ–ª—å–∫–æ –æ—Ç Model/Year
        await loadColors(brand, model, yearLow);

        // 3. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ü–æ–∫–æ–ª–µ–Ω–∏—è, –ö—É–∑–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∫–æ–≥–¥–∞ –≤—ã–±—Ä–∞–Ω–æ –ü–æ–∫–æ–ª–µ–Ω–∏–µ.
        // –ï—Å–ª–∏ –ü–æ–∫–æ–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ö—É–∑–æ–≤ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ).
    }

    async function loadGeneration(brand, model, yearLow) {
        // –ü–æ–∫–æ–ª–µ–Ω–∏–µ (generation) –∑–∞–≤–∏—Å–∏—Ç –æ—Ç Brand, Model –∏ Year
        const list = await fetchDict("generation", {
            brand,
            model,
            yearLow // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –≥–æ–¥–∞
        });

        // –ü–æ–∫–æ–ª–µ–Ω–∏–µ, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (Byte), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
        const stringList = list.map(String);
        fillSelect("generation", stringList, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ");
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –¶–≤–µ—Ç–∞
    async function loadColors(brand, model, yearLow) {
        // –¶–≤–µ—Ç (color) –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ CarAd, –Ω–æ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç Brand, Model –∏ Year
        // –ï—Å–ª–∏ Color - ENUM —Å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–æ–º (–∫–∞–∫ bodyType), –æ–Ω –≤–µ—Ä–Ω–µ—Ç —Ä—É—Å—Å–∫–∏–µ –∏–º–µ–Ω–∞.
        const list = await fetchDict("color", {
            brand,
            model,
            yearLow
        });

        fillSelect("color", list, "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç");
    }

    async function loadBodyTypes() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;
        const generation = document.getElementById("generation").value; // –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†

        fillSelect("bodyType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤");
        fillSelect("engineType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");


        if (!brand || !model || !yearLow || !generation) return;

        const list = await fetchDict("bodyType", {
            brand,
            model,
            yearLow,
            generation
        });
        fillSelect("bodyType", list, "–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–∑–æ–≤");
    }

    async function loadEngineTypes() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;
        const bodyType = document.getElementById("bodyType").value;

        fillSelect("engineType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand || !model || !yearLow || !bodyType) return;

        const list = await fetchDict("engineType", {brand, model, yearLow, bodyType});
        fillSelect("engineType", list, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å");
    }

    async function loadTransmissions() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;
        const engineType = document.getElementById("engineType").value;

        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand || !model || !yearLow || !engineType) return;

        const list = await fetchDict("transmission", {brand, model, yearLow, engineType});
        fillSelect("transmissionType", list, "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
    }

    async function loadDriveTypes() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;
        const transmissionType = document.getElementById("transmissionType").value;

        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (!brand || !model || !yearLow || !transmissionType) return;

        const list = await fetchDict("driveType", {brand, model, yearLow, transmissionType});
        fillSelect("driveType", list, "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");
    }

    function toggleEnginePowerInput(selectedValue) {
        const input = document.getElementById('enginePowerInput');

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è, —Ç–∞–∫ –∫–∞–∫ –º–æ—â–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");

        if (selectedValue === 'custom_input') {
            // –í—ã–±—Ä–∞–Ω —Ä—É—á–Ω–æ–π –≤–≤–æ–¥: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º input –∏ –¥–µ–ª–∞–µ–º –µ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
            input.style.display = 'block';
            input.setAttribute('required', 'required');
            input.value = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            input.focus();

        } else if (selectedValue !== '') {
            // –í—ã–±—Ä–∞–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞: —Å–∫—Ä—ã–≤–∞–µ–º input –∏ –ø–µ—Ä–µ–¥–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            input.style.display = 'none';
            input.value = selectedValue; // üëà –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫ DTO
            input.removeAttribute('required');

            // –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∏–∑ select, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
            loadTransmissions();

        } else {
            // –í—ã–±—Ä–∞–Ω–æ "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å" (–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
            input.style.display = 'none';
            input.value = '';
            input.removeAttribute('required');
        }
    }

    async function loadEnginePowers() {
        const brand = document.getElementById("brand").value;
        const model = document.getElementById("model").value;
        const yearLow = document.getElementById("year").value;
        const bodyType = document.getElementById("bodyType").value;
        const engineType = document.getElementById("engineType").value;

        const select = document.getElementById("enginePowerSelect");

        // –°–±—Ä–æ—Å –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–ª–µ–π –∏ —Å–ø–∏—Å–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏
        fillSelect("transmissionType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–æ–±–∫—É");
        fillSelect("driveType", [], "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–≤–æ–¥");
        fillSelect("enginePowerSelect", [], "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å");

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞
        toggleEnginePowerInput('');

        if (!brand || !model || !yearLow || !bodyType || !engineType) return;

        // –ó–∞–ø—Ä–æ—Å distinct –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è enginePower
        const list = await fetchDict("enginePower", {
            brand,
            model,
            yearLow, // –ü–µ—Ä–µ–¥–∞–µ–º –≥–æ–¥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
            bodyType,
            engineType
        });

        // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º SELECT –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        const stringList = list.map(String);
        fillSelect("enginePowerSelect", stringList, "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å (–ª.—Å.)");

        // 2. –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é"
        const customOption = document.createElement("option");
        customOption.value = "custom_input";
        customOption.textContent = "–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é...";
        select.appendChild(customOption);

        // 3. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º SELECT
        select.disabled = false;
    }

    document.addEventListener("DOMContentLoaded", loadBrands);
</script>

<script>
    function previewImage(event) {
        const input = event.target;
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    document.querySelector('form').addEventListener('submit', function (event) {
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        this.classList.add('was-validated');
    });
</script>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>
</body>
</html>